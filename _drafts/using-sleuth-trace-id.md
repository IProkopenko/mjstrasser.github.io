---
layout: post
title: Using the Spring Cloud Sleuth trace ID
categories: tech
tags: spring-boot spring-cloud
---

On a recent project we implemented an API service using [Spring
Boot](https://projects.spring.io/spring-boot/) with two operations:

1. initiate a new, asynchronous workflow
2. report on the status of an existing workflow

## A unique ID for each workflow

Each workflow needs to be identified by a unique ID to be generated by the
API service on the first call.

The service is one of a mesh of
microservices and we implemented [Spring Cloud
Sleuth](https://cloud.spring.io/spring-cloud-sleuth/)
to provide tracing across microservice calls.

Instead of generating a new ID (e.g. a UUID) we decided to take the
trace ID from Sleuth. Sleuth generates a random long integer as a trace
ID at the beginning of the request and passes that as part of
synchronous requests to other services.

Part of the rationale for using the trace ID is to reduce log message clutter.
When Sleuth is included, the IDs are inserted into the Spring logs via
the SLF4J MDC.

## Getting the Sleuth trace ID

Doing this turned out to be very simple. We created a Spring service
called `Breadcrumb` to return the formatted trace ID.

```java
package com.example;

import org.springframework.cloud.sleuth.Tracer;
import org.springframework.stereotype.Service;

@Service
public class Breadcrumb {

  @Autowired
  private Tracer tracer;

  public String breadcrumbId() {
    return tracer.getCurrentSpan().traceIdString();
  }
}
```

`Span.traceIdString()` returns the trace ID
in the same hexadecimal format used in the log messages.

The controller that handles the HTTP POST to start the workflow injects
this service and calls `breadcrumb.getBreadcrumb()` to get the current
trace ID string.

## Inserting the Sleuth trace ID

**TBC**
